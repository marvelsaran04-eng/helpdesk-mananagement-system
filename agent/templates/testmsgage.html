{% extends 'agent.html' %}

{% block title %}Real-time Chat{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row">
            <div class="col">
                <div id="chat-window" class="card">
                    <div class="card-body" id="messages">
                        <!-- Messages will be appended here -->
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                            <button id="sendMessageButton" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Output the username into a JavaScript variable
const username = '{{ request.user.username }}';

document.addEventListener('DOMContentLoaded', function() {
    const chatSocket = new WebSocket('ws://localhost:8000/ws/chat/');

    chatSocket.onopen = function(event) {
        console.log('WebSocket connection established');
    };

    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        appendMessage(data.username, data.message);
    };

    chatSocket.onerror = function(error) {
        console.error('WebSocket error:', error.message);
    };

    chatSocket.onclose = function(event) {
        console.log('WebSocket connection closed:', event.code, event.reason);
    };

    const button = document.getElementById('sendMessageButton');
    button.addEventListener('click', function() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;
        sendMessage(username, message);
        messageInput.value = '';
    });

    function appendMessage(username, message) {
        const messagesContainer = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.innerHTML = `<strong>${username}</strong>: ${message}`;
        messagesContainer.appendChild(messageElement);
    }

    function sendMessage(username, message) {
        chatSocket.send(JSON.stringify({ 'username': username, 'message': message }));
    }
});
</script>
{% endblock %}